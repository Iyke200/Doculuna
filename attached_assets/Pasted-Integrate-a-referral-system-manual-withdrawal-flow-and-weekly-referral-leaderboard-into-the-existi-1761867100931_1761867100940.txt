Integrate a referral system, manual withdrawal flow, and weekly referral leaderboard into the existing asynchronous Telegram bot.
Do not alter existing project structure â€” keep everything inside handlers/, database/, keyboards/, and utils/.


---

ğŸ  Main Menu (Inline)

When user sends /start or selects â€œğŸ¦ Walletâ€, display:

ğŸ’¼ Doculuna Wallet  
Balance: â‚¦{balance}  
Total Earned: â‚¦{total_earned}

ğŸ‘¥ Referrals: {total_referrals}
ğŸ”— Referral Code: {referral_code}

Options:
[ğŸ’° Withdraw] [ğŸ“Š Referral Stats]  
[ğŸ“œ Withdrawal History] [ğŸ† Leaderboard]


---

ğŸ‘¥ Referral System

Every user automatically gets a unique referral code: DOCU<user_id>.

When a new user joins using someoneâ€™s referral code or link, save referrer_id.

Each user can only be referred once.

Referrers earn only when the referred user successfully purchases a premium plan.


Premium Plan Rewards:

Weekly (â‚¦1,000) â†’ referrer earns â‚¦150

Monthly (â‚¦3,500) â†’ referrer earns â‚¦350

Reward credited immediately after payment confirmation.


Referral Table

class Referral(Base):
    id: int
    referrer_id: int
    referred_id: int
    plan_type: str  # "weekly" or "monthly"
    reward_amount: int
    status: str  # "pending" or "completed"
    created_at: datetime

Wallet Table

class Wallet(Base):
    user_id: int
    balance: int = 0
    total_earned: int = 0

On reward:

wallet.balance += reward_amount
wallet.total_earned += reward_amount


---

ğŸ’¸ Manual Withdrawal Flow

Minimum: â‚¦2,000
Process:

1. User clicks â€œğŸ’° Withdrawâ€.


2. Bot asks for:

Amount

Account name

Bank name

Account number



3. Save request to database as "pending".


4. Notify user:

> â€œâœ… Withdrawal request submitted and is pending admin review.â€





WithdrawalRequest Table

class WithdrawalRequest(Base):
    id: int
    user_id: int
    amount: int
    account_name: str
    bank_name: str
    account_number: str
    status: str  # "pending", "approved", "rejected"
    created_at: datetime
    processed_at: datetime | None


---

ğŸ§‘â€ğŸ’¼ Admin Flow

When a withdrawal is created:

Bot sends admin message:

ğŸ’¸ New Withdrawal Request
User: @username (ID: {user_id})
Amount: â‚¦{amount}
Account Name: {account_name}
Bank: {bank_name}
Account Number: {account_number}

Inline admin buttons: Approve âœ… | Reject âŒ


If Approved:

Deduct from wallet.

Update status to "approved".

Notify user:

> â€œâœ… Your â‚¦{amount} withdrawal has been approved.â€




If Rejected:

Mark as "rejected", do not deduct funds.

Notify user.



---

ğŸ“Š Referral Stats Menu

When user clicks â€œğŸ“Š Referral Statsâ€:

ğŸ‘¥ Referral Summary
Total Referrals: {count}
Completed Referrals: {completed}
Pending Referrals: {pending}

ğŸ’¸ Total Earned from Referrals: â‚¦{total_earned}
ğŸ”— Your Referral Link: t.me/{BOT_USERNAME}?start={referral_code}


---

ğŸ† Leaderboard System

Show top 10 referrers (based on total completed referrals or total earned).

Update automatically each week.

Store leaderboard data in a Leaderboard table or generate dynamically.


Display:

ğŸ† Weekly Referral Leaderboard

1ï¸âƒ£ @username1 â€” â‚¦4500
2ï¸âƒ£ @username2 â€” â‚¦3800
3ï¸âƒ£ @username3 â€” â‚¦3100
...
10ï¸âƒ£ @username10 â€” â‚¦900

ğŸ”¥ Keep referring to reach the top!

Leaderboard Table (optional)

class Leaderboard(Base):
    id: int
    user_id: int
    total_earned: int
    week_start: date
    week_end: date

If dynamic, simply query top users by Wallet.total_earned within the last 7 days.


---

ğŸ“œ Withdrawal History

When user clicks â€œğŸ“œ Withdrawal Historyâ€:

ğŸ“œ Your Withdrawal History

1. â‚¦1500 - Pending
2. â‚¦2000 - Approved
3. â‚¦1000 - Rejected

If none:

> â€œYou have no past withdrawals yet.â€




---

âš™ï¸ General Rules

Use async/await everywhere.

Validate:

No duplicate referrals.

No withdrawal below â‚¦2,000.

No multiple pending withdrawals.


Notify users and admin for every action.

Keep code modular, clean, and readable.

Inline keyboards for everything â€” no text-based command input.

Maintain existing handlers and file structure.



---

ğŸ§© Inline Keyboards

User Menu

[
  [InlineKeyboardButton("ğŸ’° Withdraw", callback_data="withdraw")],
  [InlineKeyboardButton("ğŸ“Š Referral Stats", callback_data="ref_stats")],
  [InlineKeyboardButton("ğŸ“œ Withdrawal History", callback_data="withdraw_history")],
  [InlineKeyboardButton("ğŸ† Leaderboard", callback_data="leaderboard")]
]

Admin Menu

[
  [InlineKeyboardButton("âœ… Approve", callback_data="approve_{id}")],
  [InlineKeyboardButton("âŒ Reject", callback_data="reject_{id}")]
]